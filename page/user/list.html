<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>用户列表</title>
		<!-- 外部样式表 -->
		<link rel="stylesheet" href="../../iframe/dist/css/layui.css" media="all"/>
		
	</head>
	<body>
	<div style="width: 80%;margin-left: auto;margin-right: auto;margin-top: 50px;">
		
	<form class="layui-form" action="">
	  
	  <div class="layui-form-item">
	    <label class="layui-form-label">用户id</label>
	    <div class="layui-input-block">
	      <input type="text" name="id" placeholder="请输入用户id" autocomplete="off" class="layui-input">
	    </div>
	  </div>
	  
	  <div class="layui-form-item">
	    <div class="layui-input-block">
	      <button class="layui-btn" lay-submit lay-filter="search">全部查询</button>
	     
	    </div>
	  </div>
	</form>
	 
	 </div>
	 
	 <table id="user" lay-filter="userTable"> </table>
	 
	 
	 <a href="../score/list2.html">成绩</a>
	  <a href="../user/list.html">用户</a>
	   <a href="../course/list1.html">课程</a>
	   
	   
	  
	   <!-- 表上的工具条模板-->
	   <!-- <div class="layui-btn-group" id="allBar">
		 <button type="button" class="layui-btn layui-btn-primary" lay-event="add">新增</button>
	     <button type="button" class="layui-btn layui-btn-primary" lay-event="update">修改</button>
	     <button type="button" class="layui-btn layui-btn-primary" lay-event="del">删除</button>
	   
	   </div> -->
		
	   <script type="text/html" id="allBar">
		 <a class="layui-btn layui-btn-primary" lay-event="add">新增</a>
	     <a class="layui-btn layui-btn-primary" lay-event="update">修改</a>
	     <a class="layui-btn layui-btn-primary" lay-event="del">删除</a>
	   </script>
	    <!-- 行间的工具条模板 -->
		
	<!-- <script type="text/html" class="layui-btn-group" id="barUpdateDele">
			 
	  <button type="button" class="layui-btn layui-btn-primary" lay-event="updateUser">修改</button>
	  <button type="button" class="layui-btn layui-btn-primary" lay-event="delUser">删除</button>
	
	</script> -->
	
	<script type="text/html" id="barUpdateDele">
	   <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="updateUser">修改</a>
	   <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="delUser">删除</a>
	 
    </script>
	 
	 
	 
	<script src="../../iframe/dist/layui.all.js"></script>
	<script >
		
		
	//Demo
	layui.use(['form','jquery','table','laypage'], function(){
	  var form = layui.form;
	  var $ = layui.jquery;
	  var table = layui.table;
	  var laypage = layui.laypage;
	  
	  
	  // 监听表格行间操作事件
	  table.on('tool(userTable)',function(obj){
		  
		  console.log(obj)
		  
		  if(obj.event == 'updateUser'){
			  layer.msg('修改');
			  layer.open({
			  	 title:'更改用户信息',
			     type:2, 
			  	 area:['100%','100%'],
			  	 content: './update.html?id='+obj.data.id
				 });
			  // location.href = './update.html?id='+obj.data.id;
			 
		  }else if(obj.event == 'delUser'){
			  layer.confirm('真的删除行:id:'+obj.data.id+'么？', function(index){
				delUser(obj.data.id);
				obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
				layer.close(index);
				// location.reload();
				
				
			  });
			  
			  
		  }else{
			  layer.msg('未知事件')
		  }
		  
	  });
	  
	  // table.on('tool(test)', function(obj){ //注：tool 是工具条事件名，test 是 table 原始容器的属性 lay-filter="对应的值"
	  //   var data = obj.data; //获得当前行数据
	  //   var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
	  //   var tr = obj.tr; //获得当前行 tr 的 DOM 对象（如果有的话）
	   
	  //   if(layEvent === 'detail'){ //查看
	  //     //do somehing
	  //   } else if(layEvent === 'del'){ //删除
	  //     layer.confirm('真的删除行么', function(index){
	  //       obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
	  //       layer.close(index);
	  //       //向服务端发送删除指令
	  //     });
	  //   } else if(layEvent === 'edit'){ //编辑
	  //     //do something
	      
	  //     //同步更新缓存对应的值
	  //     obj.update({
	  //       username: '123'
	  //       ,title: 'xxx'
	  //     });
	  //   } else if(layEvent === 'LAYTABLE_TIPS'){
	  //     layer.alert('Hi，头部工具栏扩展的右侧图标。');
	  //   }
	  // });
	  //监听表头按钮
	  table.on('toolbar(userTable)',function(data){
		  
		  var checkStatus = table.checkStatus(data.config.id);
          console.log(tableIns.config.page.pages);
		  if(data.event == 'add'){
			  layer.open({
				title:'新增用户',
			    type:2, 
				area:['100%','100%'],
                cancel: function(index, layero){
				  if(confirm('确定要关闭么')){ //只有当点击confirm框的确定时，该层才会关闭
				    layer.close(index)
                      tableIns.reload({
                          page: {
                              curr: tableIns.config.page.pages //重新从第 1 页开始
                          }
                      });


				  }
				   
				},  
			    content: './register.html' //这里content是一个普通的String
			    //content: $('#addUserForm') //这里content是一个普通的String
				//<div id="tong" class="hide" style="width: 670px;height: 320px;display: none;">
			  });
		  }
		  if(data.event == 'update'){
			   if(checkStatus.data.length === 0) {
			         layer.msg('请选择一行');
			   } else if(checkStatus.data.length > 1) {
			         layer.msg('只能同时编辑一个');
			   } else{
				   // location.href = './update.html?id='+checkStatus.data[0].id;
				   layer.open({
					   title:'更改用户信息',
					   type:2,
					   area:['100%','100%'],
					   content: './update.html?id='+checkStatus.data[0].id,
					   end: function(index, layero){
					   		//layer.msg('要关更新窗口了')
						   reloadTable();
					   }
				     //content: $('#addUserForm') //这里content是一个普通的String
				   				//<div id="tong" class="hide" style="width: 670px;height: 320px;display: none;">
				   });
				   // console.log("a:"+data.update);
				    // obj.update({
				    //      username: '123'
				    //      ,title: 'xxx'
				    //    });
			   }
			 
		  }
		  if(data.event == 'del'){
				if(checkStatus.data.length === 0) {
				      layer.msg('请选择一行');
				}else{
					
					var myString = "";
					for(i in checkStatus.data){
						myString=myString+JSON.stringify(checkStatus.data[i])+"";
					}
					if(confirm('确定要删除这些行么？'+myString)){
						let ids = [];
						for(i in checkStatus.data){
							ids.push(checkStatus.data[i].id);
						}
						delUser(ids,reloadTable);

					}

				 //只有当点击confirm框的确定时，该层才会关闭
				// 	   // layer.close(index)
				// 	   // location.reload()
				// }
		  }
		  }
	  });

	  table.on('edit(userTable)',function (obj) {

	  })

	  let tableHead = [[ //标题栏
	  			      {checkbox: true}
	  			     ,{field: 'id', title: 'ID', width: '5%'}
	  			     ,{field: 'name', title: '姓名', width: '8%'}
	  			     ,{field: 'major', title: '专业', width: '8%'}
	  			     ,{field: 'haoma', title: '学号', width: '8%'}
	  			     ,{field: 'sex', title: '性别', width: '8%',templet:(row)=>{  return row.sex==1?'女':'男'}}
	  			     ,{field: 'college', title: '院系', width: '8%'}
	  			     ,{field: 'password', title: '密码', width: '8%'}
	  			     ,{field: 'updateTime', title: '更新时间', width: '8%'}
	  			     ,{field: 'createTime', title: '创建时间', width: '8%'}
	  			     ,{field: 'remark', title: '备份', width: '8%'}
	  			      ,{field: '', title: '操作',toolbar:'#barUpdateDele'}
	  			    ]];
					
	 // laypage.render({
	 //   elem: 'user'
	  
	 //   ,jump: function(obj1, first1){
	 //     //obj包含了当前分页的所有参数，比如：
	     
	     
	 //     //首次不执行
	 //     // if(!first){
	 //       //do something
	 //     // }
	 //   }
	 // });
	 // console.log("obj1.curr:"+obj1.curr); //得到当前页，以便向服务端请求对应页的数据。
	 // console.log("obj1.limit:"+obj1.limit); //得到每页显示的条数
	 
	 var tableIns = table.render({
		 id: 'idTest',
	 	elem:'#user',
		
	 	cols:  tableHead,
		url:'/api/user/search',
	 	toolbar: '#allBar' //开启头部工具栏，并为其绑定左侧模板
	     ,defaultToolbar: ['filter', 'exports', 'print', { //自定义头部工具栏右侧图标。如无需自定义，去除该参数即可
	 		title: '提示'
	         ,layEvent: 'LAYTABLE_TIPS'
	         ,icon: 'layui-icon-tips'
	       }]
	     ,title: '用户数据表'
		 ,page:true
		 ,limit:10
		 // ,limit:[10,30,50,100]
		 ,request: {
		     pageName: 'page' //页码的参数名称，默认：page
		     ,limitName: 'rows' //每页数据量的参数名，默认：limit
		 }
		 ,response: {
		   statusName: 'code' //规定数据状态的字段名称，默认：code
		   ,statusCode: 200 //规定成功的状态码，默认：0
		   ,msgName: 'msg' //规定状态信息的字段名称，默认：msg
		   ,countName: 'total' //规定数据总数的字段名称，默认：count
		   ,dataName: 'data' //规定数据列表的字段名称，默认：data
		 } 
		//  ,parseData: function(res){ //res 即为原始返回的数据
		// 	console.log(JSON.stringify(res))
		// 	return {
		// 	  "code": res.code, //解析接口状态
		// 	  "msg": res.msg, //解析提示文本
		// 	  "count": res.total, //解析数据长度
		// 	  "data": res.data //解析数据列表
		// 	};
		// }
		
		});
	 // });
	 
	 
	 
	  

	 	
		
		
		// --   独立定义的方法
		/**
		 *
		 * @param ids 多个id组成的数组 如： [38,478,32]
		 * @param reloadTableFun 删除成功后刷新页面的回调函数
		 */
		function delUser(ids,reloadTableFun){

			$.ajax({
				  	url:'/api/user/dels',
				  	//data:JSON.stringify( submitData),
				  	data: {ids:ids},
				  	type:'POST',
					//dataType: 'json',
					//contentType: 'application/json',
				  	success:function(res){
							if(res && res.code == 200){
								layer.msg("id:"+ids+"删除成功");

								if(typeof reloadTableFun == 'function'){
									reloadTableFun();
								}

							}else{
							 console.log("id:"+ids+"删除失败",{time:5000});

						    }
					},
					error:function(){
						console.log("id:"+ids+"删除异常",{time:5000});
					}
				});
		}

		function reloadTable(tableId) {
			if(!tableId){
				tableId = "idTest";
			}
			table.reload(tableId);
		}
	});
	
	

	</script>
	
	</body>
</html>
