<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>用户列表</title>
		<!-- 外部样式表 -->
		<link rel="stylesheet" href="../../iframe/dist/css/layui.css" media="all"/>
		
	</head>
	<body>
    <ul class="layui-nav" lay-filter="">
        <li class="layui-nav-item"><a href="">用户管理</a></li>
        <li class="layui-nav-item"><a href='../course/list.html'>课程管理</a></li>
        <li class="layui-nav-item"><a href='../score/list.html'>成绩管理</a></li>
        <li class="layui-nav-item">
            <a href="javascript:;">解决方案</a>
            <dl class="layui-nav-child"> <!-- 二级菜单 -->
                <dd><a href="">移动模块</a></dd>
                <dd><a href="">后台模版</a></dd>
                <dd><a href="">电商平台</a></dd>
            </dl>
        </li>
        <li class="layui-nav-item"><a href="">帮助</a></li>
        <li class="layui-nav-item"><a href="../common/usedTechnology.html">总结</a></li>
    </ul>
    <div class="layui-card">
        <div class="layui-card-header">用户管理</div>
        <div class="layui-card-body">
<!--	<div style="padding: 10px;">-->

        <form class="layui-form" action="" lay-filter="searchForm">

    <!--        <div class="layui-container">-->
    <!--            常规布局（以中型屏幕桌面为例）：-->
                <div class="layui-row">
                    <div class="layui-col-md4">
                        <div class="layui-form-item">
                            <label class="layui-form-label">用户id</label>
                            <div class="layui-input-block">
                                <input type="text" name="id" placeholder="请输入用户id" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-md4">
                        <div class="layui-form-item">
                            <label class="layui-form-label">姓名</label>
                            <div class="layui-input-block">
                                <input type="text" name="name" required  lay-verify="required" placeholder="请输入姓名" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-md4">
                        <div class="layui-form-item">
                            <label class="layui-form-label">专业</label>
                            <div class="layui-input-block">
                                <input type="text" name="major" required  lay-verify="required" placeholder="请输入专业" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-row">
                    <div class="layui-col-md4">
                        <div class="layui-form-item">
                            <label class="layui-form-label">学号</label>
                            <div class="layui-input-block">
                                <input type="text" name="haoma" required  lay-verify="required" placeholder="请输入学号" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                     </div>
                    <div class="layui-col-md4">
                        <div class="layui-form-item">
                            <label class="layui-form-label">性别</label>
                            <div class="layui-input-block">

                                <input type="radio" name="sex" value="1" title="男">
                                <input type="radio" name="sex" value="2" title="女">
                                <input type="radio" name="sex" value="0" title="全部" checked>

                            </div>
                        </div>
                    </div>
                    <div class="layui-col-md4">
                        <div class="layui-form-item">
                            <label class="layui-form-label">院系</label>
                            <div class="layui-input-block">
                                <input type="text" name="college" required  lay-verify="required" placeholder="请输入院系" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                    </div>
                </div>
            <div class="layui-row">
                <div class="layui-col-md4">
                    <div class="layui-form-item">
                        <label class="layui-form-label">更新时间</label>
                        <div class="layui-input-block">
                            <input type="text" class="layui-input" id="updateTime" name="updateTime" placeholder="请输入更新时间">
                        </div>
                    </div>
                </div>
                <div class="layui-col-md4">
                    <div class="layui-form-item">
                        <label class="layui-form-label">创建时间</label>
                        <div class="layui-input-block">
                            <input type="text" class="layui-input" id="createTime" name="createTime" placeholder="请输入创建时间">
                        </div>
                    </div>
                </div>
                <div class="layui-col-md4">
                    <div class="layui-form-item">
                            <label class="layui-form-label">备注</label>
                            <div class="layui-input-block">
                                <input type="text" name="remark" required  lay-verify="required" placeholder="请输入备注" autocomplete="off" class="layui-input">
                            </div>
                    </div>
                </div>
            </div>

        </form>

        </div>
    </div>
<!--    </div>-->


    <div class="layui-row">
        <div class="layui-hide">
            <button class="layui-btn layui-btn-primary" id="importExcel">导入Excel文件</button>
        </div>

        <div class="layui-col-md1">

        <label class="layui-form-label" style="display: none;" id="jingdutiao">导入Excel上传进度条</label>

        </div>

        <div class="layui-col-md11">

            <div class="layui-progress layui-progress-big" lay-filter="demo" lay-showPercent="true" id="barId" style="display: none;" align="center">
                <div class="layui-progress-bar" lay-percent="0%"></div>
            </div>

        </div>



    </div>

<!--    <button class="layui-btn layui-btn-primary" id="exportExcel">导出为Excel文件</button>-->


    <table class="layui-hide" id="user" lay-filter="userTable"> </table>


    <script type="text/html" id="allBar">
        <a class="layui-btn layui-btn-normal" lay-event="search">查询</a>
        <a class="layui-btn " lay-event="add">新增</a>
        <a class="layui-btn  layui-btn-warm" lay-event="update">修改</a>
        <a class="layui-btn  layui-btn-danger" lay-event="del">删除</a>
        <a class="layui-btn layui-btn-primary" lay-event="exportExcel">导出为Excel文件</a>
        <a class="layui-btn layui-btn-primary" lay-event="importExcel">导入Excel文件</a>

    </script>
    <!-- 行间的工具条模板 -->


    <script type="text/html" id="barUpdateDele">
        <a class="layui-btn layui-btn-warm layui-btn-xs" lay-event="updateUser">修改</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="delUser">删除</a>

    </script>
	 
	 
	 
	<script src="../../iframe/dist/layui.all.js"></script>
	<script >

        function showPhoto(phoPath,id) {
            console.log(phoPath,id);
                layer.open({
                    title: "头像显示,用户的id为"+id,
                    type: 1,

                    area: ['800px', '500px'],

                    content: '<img src="../../resources/upload/images/user/' + phoPath + '"  />'
                });

        }
		
	//Demo
	layui.use(['form','jquery','table','laydate','element','upload'], function(){
	  var form = layui.form;
	  var $ = layui.jquery;
	  var table = layui.table;
	  var laydate = layui.laydate;
	  var element = layui.element;
	  var upload = layui.upload;

        var uploadInst = upload.render({
            elem: '#importExcel'
            ,url: '/api/user/importExcel'
            ,accept: 'file'
            ,progress: function(n, elem) {
                document.getElementById('barId').style.display="";
                document.getElementById('jingdutiao').style.display="";
                var percent = n + '%' //获取进度百分比
                element.progress('demo', percent); //可配合 layui 进度条元素使用

                //以下系 layui 2.5.6 新增
                console.log(elem); //得到当前触发的元素 DOM 对象。可通过该元素定义的属性值匹配到对应的进度条。
            }
            ,done: function(res){
                if(res.code == 200){
                    layer.confirm('全部数据导入成功。'+res.data, function(index){
                        tableIns.reload();
                        layer.close(index);
                    });

                }
                if(res.code == 500){
                    layer.confirm('数据并未全部导入。'+res.data, function(index){
                        tableIns.reload();
                        layer.close(index);
                    });

                }
            }
            ,error: function(){
                //请求异常回调
                layer.msg("导入文件异常");
            }
        });

	  laydate.render({
            elem: '#updateTime'//指定元素
          // type: 'datetime'
        })

        laydate.render({
            elem: '#createTime' //指定元素
            // type: 'datetime'
        })
	  // 监听表格行间操作事件
	  table.on('tool(userTable)',function(obj){
		  
		  console.log(obj)
		  
		  if(obj.event == 'updateUser'){
			  layer.msg('修改');
			  layer.open({
			  	 title:'更改用户信息',
			     type:2, 
			  	 area:['100%','100%'],
			  	 content: './update.html?id='+obj.data.id,
                  end: function(index, layero){
                      //layer.msg('要关更新窗口了')
                      reloadTable();
                  }

				 });
			  // location.href = './update.html?id='+obj.data.id;
			 
		  }else if(obj.event == 'delUser'){
			  layer.confirm('真的删除行:id:'+obj.data.id+'么？', function(index){
                  var ids = [];
                  ids.push(obj.data.id);
                  searchScoreStuId(ids);
				
				
			  });
			  
			  
		  }else{
			  layer.msg('未知事件')
		  }
		  
	  });
	  

	  //监听表头按钮
	  table.on('toolbar(userTable)',function(data){
		  
		  var checkStatus = table.checkStatus(data.config.id);


		  if(data.event == 'search'){//查询  表格内容
		      console.log(form.val('searchForm'))
              table.reload('idTest', {
                  url: '/api/user/search',
                  where: form.val('searchForm')
                  //设定异步数据接口的额外参数
                  // , parseData: function (res) { //res 即为原始返回的数据
                  //     console.log(JSON.stringify(res))
                  //     return {
                  //         "code": res.code, //解析接口状态
                  //         "msg": res.msg, //解析提示文本
                  //         // "count": 1, //解析数据长度
                  //          "data": [res.data] //解析数据列表
                  //     };
                  // }

              });
          }else if(data.event == 'add'){
			  layer.open({
				title:'新增用户',
			    type:2, 
				area:['100%','100%'],
                  end: function(){
                      tableIns.reload({
                          page: {
                              curr: tableIns.config.page.pages //重新从第 1 页开始
                          }
                      });
                  },
			    content: './register.html' //这里content是一个普通的String
			    //content: $('#addUserForm') //这里content是一个普通的String
				//<div id="tong" class="hide" style="width: 670px;height: 320px;display: none;">
			  });
		  }
		  if(data.event == 'update'){
			   if(checkStatus.data.length === 0) {
			         layer.msg('请选择一行');
			   } else if(checkStatus.data.length > 1) {
			         layer.msg('只能同时编辑一个');
			   } else{
				   // location.href = './update.html?id='+checkStatus.data[0].id;
				   layer.open({
					   title:'更改用户信息',
					   type:2,
					   area:['100%','100%'],
					   content: './update.html?id='+checkStatus.data[0].id,
					   end: function(index, layero){
					   		//layer.msg('要关更新窗口了')
						   reloadTable();
					   }
				     //content: $('#addUserForm') //这里content是一个普通的String
				   				//<div id="tong" class="hide" style="width: 670px;height: 320px;display: none;">
				   });
				   // console.log("a:"+data.update);
				    // obj.update({
				    //      username: '123'
				    //      ,title: 'xxx'
				    //    });
			   }
			 
		  }
		  if(data.event == 'del'){
				if(checkStatus.data.length === 0) {
				      layer.msg('请选择一行');
				}else{
					
					let myString = "";
					for(i in checkStatus.data){
						myString=myString+JSON.stringify(checkStatus.data[i])+"";
					}
					if(confirm('确定要删除这些行么？'+myString)){
					    var ids = [];
						for(i in checkStatus.data){
							ids.push(checkStatus.data[i].id);
						}
                        // delUser(ids,reloadTable);
                        searchScoreStuId(ids);

                    }

		  }
		  }
          if(data.event == 'exportExcel'){
              let url = "/api/user/exportExcel";
              //window.open(url,'download');
              window.open(url,'_blank');

          }

          if(data.event == 'importExcel'){
              $("#importExcel").click();

          }



	  });

        //监听行双击事件
        table.on('rowDouble(userTable)', function(obj){
            console.log(obj.tr) //得到当前行元素对象
            console.log(obj.data) //得到当前行数据
            //obj.del(); //删除当前行
            //obj.update(fields) //修改当前行数据
            let row = obj.data;// row = {id:1,photo:'fjwoajfeowwa.jpg'}
            let photo = row.photo;
            if(photo) {
                showPhoto(row.photo,row.id);
            }else {
                layer.msg('没有头像')
            }
        });

	  let tableHead = [[ //标题栏
	  			      // {checkbox: true}
                      {type:'checkbox', fixed: 'left'}
	  			     ,{field: 'id', title: 'ID',fixed: 'left'}
	  			     ,{field: 'name', title: '姓名',fixed: 'left'}
                      ,{field: 'myPhoto', title: '头像',templet:function(d){
                          return (!d.photo)?'<span style="color:red">无</span>':'有'
                       }}
                     ,{field: 'major', title: '专业',width:100}
	  			     ,{field: 'haoma', title: '学号',width:100}
	  			     ,{field: 'sex', title: '性别',templet:(row)=>{  return row.sex==1?'男':'女'}}
	  			     ,{field: 'college', title: '院系',width:100}
	  			     ,{field: 'password', title: '密码',width:100}
	  			     ,{field: 'updateTime', title: '更新时间',width:200}
	  			     ,{field: 'createTime', title: '创建时间',width:200}
	  			     ,{field: 'remark', title: '备注'}
                     ,{field: 'detail', title: '个人详情',width:100,templet:function(d){
                         return (!d.details)?'<span style="color:red">无</span>':'有'
                      }}
	  			      ,{field: '', title: '操作',fixed: 'right',width:150,toolbar:'#barUpdateDele'}
	  			    ]];
					

	 
	 var tableIns = table.render({
		 id: 'idTest',
	 	elem:'#user',
	 	cols:  tableHead,
		url:'/api/user/search'
         ,cellMinWidth: 100
	 	,toolbar: '#allBar' //开启头部工具栏，并为其绑定左侧模板
	     ,defaultToolbar: ['filter', 'exports', 'print', { //自定义头部工具栏右侧图标。如无需自定义，去除该参数即可
	 		title: '提示'
	         ,layEvent: 'LAYTABLE_TIPS'
	         ,icon: 'layui-icon-tips'
	       }]
	     ,title: '用户数据表'
		 ,page:true
		 ,limit:10
		 // ,limit:[10,30,50,100]
		 ,request: {
		     pageName: 'page' //页码的参数名称，默认：page
		     ,limitName: 'rows' //每页数据量的参数名，默认：limit
		 }
		 ,response: {
		   statusName: 'code' //规定数据状态的字段名称，默认：code
		   ,statusCode: 200 //规定成功的状态码，默认：0
		   ,msgName: 'msg' //规定状态信息的字段名称，默认：msg
		   ,countName: 'total' //规定数据总数的字段名称，默认：count
		   ,dataName: 'data' //规定数据列表的字段名称，默认：data
		 } 
		//  ,parseData: function(res){ //res 即为原始返回的数据
		// 	console.log(JSON.stringify(res))
		// 	return {
		// 	  "code": res.code, //解析接口状态
		// 	  "msg": res.msg, //解析提示文本
		// 	  "count": res.total, //解析数据长度
		// 	  "data": res.data //解析数据列表
		// 	};
		// }

		});
	 // });
	 
	 
	 
	  

	 	
		
		
		// --   独立定义的方法
        function searchScoreStuId(ids){

            $.ajax({
                url:'/api/score/getByStuIds',
                //data:JSON.stringify( submitData),   //用个注释的属性，是为了后端接收嵌套对象（复杂类型）
                data: {stuIds:ids},
                type:'POST',
                //dataType: 'json',
                //contentType: 'application/json',
                success:function(res){
                    if(res.code == 404){
                        console.log("score表中没有数据")
                        delUser(ids,reloadTable);
                    }else{
                        console.log("score表中有数据");
                        layer.msg("score表中有数据");
                        layer.confirm('您要删除的用户中有用户在score表有成绩，请问还需要删吗？（' +
                            '删用户的同时会把用户在score表中的成绩一块删了）', function(index){
                            delUser(ids,reloadTable);
                            layer.close(index);
                        });


                    }
                },
                error:function(){
                    console.log("id:"+ids+"删除异常",{time:5000});
                }
            });
        }
		/**
		 *
		 * @param ids 多个id组成的数组 如： [38,478,32]
		 * @param reloadTableFun 删除成功后刷新页面的回调函数
		 */
		function delUser(ids,reloadTableFun){

			$.ajax({
				  	url:'/api/user/dels',
				  	//data:JSON.stringify( submitData),
				  	data: {ids:ids},
				  	type:'POST',
					//dataType: 'json',
					//contentType: 'application/json',
				  	success:function(res){
							if(res && res.code == 200){
								layer.msg("id:"+ids+"删除成功");

								if(typeof reloadTableFun == 'function'){
									reloadTableFun();
								}

							}else{
							 console.log("id:"+ids+"全部或者部分删除失败",{time:5000});
                                layer.msg("id:"+ids+"全部或者部分删除失败");
                                if(typeof reloadTableFun == 'function'){
                                    reloadTableFun();
                                }

						    }
					},
					error:function(){
						console.log("id:"+ids+"删除异常",{time:5000});
					}
				});
		}

		function reloadTable(tableId) {
			if(!tableId){
				tableId = "idTest";
			}
			table.reload(tableId);
		}
	});
	
	

	</script>
	
	</body>
</html>
